# 캘리브레이션 가이드

누룽지 카운팅 시스템의 정확도를 최적화하기 위한 캘리브레이션 절차입니다.

## 왜 캘리브레이션이 필요한가?

객체 감지 파라미터는 다음 요인에 따라 달라집니다:
- 누룽지 크기 및 색상
- 팬 재질 및 색상
- 조명 조건
- 카메라 높이 및 각도

**캘리브레이션을 통해 정확도를 90~95%로 향상**시킬 수 있습니다.

## 준비물

1. 라즈베리 파이 (설치된 상태)
2. 누룽지 샘플 (10~20개)
3. 팬 (실제 사용하는 것)
4. PC (캘리브레이션 도구 실행)

## 캘리브레이션 절차

### 1단계: 테스트 이미지 수집

#### 1.1 라즈베리 파이에서 이미지 촬영

```bash
cd edge_device
python3 test_camera.py
```

메뉴에서 **1. 카메라 기본 동작 확인** 선택

#### 1.2 다양한 시나리오 촬영

다음 시나리오별로 이미지를 촬영하세요:

1. **빈 팬** (0개)
2. **1개**
3. **5개** (균등 배치)
4. **10개** (균등 배치)
5. **15개** (겹침 있음)
6. **최대 개수** (팬 가득)

각 시나리오당 3~5장 촬영

#### 1.3 이미지 PC로 복사

```bash
# 라즈베리 파이에서
cd /tmp/nurungji_test
ls

# PC로 복사 (scp 사용)
scp pi@192.168.1.50:/tmp/nurungji_test/*.jpg ./test_images/
```

### 2단계: 캘리브레이션 도구 사용

#### 2.1 도구 실행

```bash
cd calibration
python calibration_tool.py
```

#### 2.2 이미지 로드

1. **📂 이미지 열기** 버튼 클릭
2. 테스트 이미지 선택 (5개 이미지부터 시작)

#### 2.3 파라미터 조정

##### 이진화 임계값 (Binary Threshold)
- **역할**: 배경과 누룽지 분리
- **조정 방법**:
  - 값을 낮추면 → 어두운 부분이 더 많이 감지됨
  - 값을 높이면 → 밝은 부분만 감지됨
- **권장 범위**: 100~150
- **최적화**:
  1. 슬라이더를 움직이며 감지 결과 확인
  2. 누룽지는 감지되고 배경은 무시되는 값 찾기

##### 최소 면적 (Min Area)
- **역할**: 노이즈 제거 (작은 점들 무시)
- **조정 방법**:
  - 값을 높이면 → 작은 객체 무시
  - 값을 낮추면 → 작은 노이즈도 감지
- **권장 범위**: 300~1000
- **최적화**:
  1. 누룽지보다 작은 노이즈가 감지되는지 확인
  2. 노이즈는 무시하고 누룽지만 감지되도록 조정

##### 최대 면적 (Max Area)
- **역할**: 겹친 누룽지 또는 큰 객체 제외
- **조정 방법**:
  - 값을 낮추면 → 큰 객체 무시
  - 값을 높이면 → 큰 객체도 감지
- **권장 범위**: 5000~15000
- **최적화**:
  1. 누룽지 1개 크기 확인
  2. 2~3개 겹친 크기는 제외되도록 설정

##### 최소/최대 종횡비 (Aspect Ratio)
- **역할**: 모양 필터 (정사각형/직사각형)
- **조정 방법**:
  - 누룽지가 정사각형이면: 0.8~1.2
  - 직사각형이면: 범위 확대
- **권장 범위**: 0.5~2.0
- **최적화**:
  1. 누룽지 모양 확인
  2. 비정상적인 모양 제외

#### 2.4 파라미터 저장

1. **💾 파라미터 저장** 버튼 클릭
2. 파일 저장 (예: `calibrated_params.txt`)

### 3단계: 파라미터 적용

#### 3.1 파일 내용 확인

```python
# calibrated_params.txt 내용 예시

BINARY_THRESHOLD = 127
MIN_AREA = 500
MAX_AREA = 10000
MIN_ASPECT_RATIO = 0.50
MAX_ASPECT_RATIO = 2.00
```

#### 3.2 edge_device/config.py 업데이트

라즈베리 파이의 `edge_device/config.py` 파일 수정:

```python
# 객체 감지 파라미터 (캘리브레이션 결과)
BINARY_THRESHOLD = 127      # ← 조정된 값으로 변경
MIN_AREA = 500              # ← 조정된 값으로 변경
MAX_AREA = 10000            # ← 조정된 값으로 변경
MIN_ASPECT_RATIO = 0.5      # ← 조정된 값으로 변경
MAX_ASPECT_RATIO = 2.0      # ← 조정된 값으로 변경
```

#### 3.3 재시작

```bash
# 라즈베리 파이 프로그램 재시작
python3 main.py
```

### 4단계: 검증

#### 4.1 정확도 테스트

1. 누룽지 **1개** 놓기 → 감지 개수 확인
2. **5개** 추가 → 감지 개수 확인
3. **10개** 추가 → 감지 개수 확인
4. **15개** 추가 → 감지 개수 확인
5. **최대** 추가 → 감지 개수 확인

#### 4.2 결과 기록

| 실제 개수 | 감지 개수 | 오차 | 정확도 |
|----------|----------|------|--------|
| 1        | 1        | 0    | 100%   |
| 5        | 5        | 0    | 100%   |
| 10       | 10       | 0    | 100%   |
| 15       | 14       | -1   | 93%    |
| 20       | 19       | -1   | 95%    |

#### 4.3 목표 정확도

- **우수**: 95% 이상
- **양호**: 90~95%
- **재조정 필요**: 90% 미만

### 5단계: 미세 조정

정확도가 낮으면 다음을 시도하세요:

#### 문제 1: 누룽지가 감지 안됨

**원인**: 이진화 임계값 너무 높음

**해결**:
```python
BINARY_THRESHOLD = 100  # 값을 낮춤 (127 → 100)
```

#### 문제 2: 배경 노이즈가 감지됨

**원인**: 최소 면적 너무 낮음

**해결**:
```python
MIN_AREA = 800  # 값을 높임 (500 → 800)
```

#### 문제 3: 겹친 누룽지가 1개로 인식

**원인**: 감지 알고리즘 한계

**해결**:
- 누룽지를 겹치지 않게 배치하도록 작업 흐름 개선
- 또는 AI 모델 사용 (Phase 3)

#### 문제 4: 조명 변화에 따라 정확도 변동

**원인**: 고정 임계값 사용

**해결**:
```python
# detector.py에서 적응형 이진화 사용
binary = cv2.adaptiveThreshold(
    image, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv2.THRESH_BINARY, 11, 2
)
```

## 고급 캘리브레이션

### 적응형 이진화

조명이 불균등한 경우:

```python
# detector.py의 _apply_threshold() 수정

def _apply_threshold(self, image):
    # 적응형 임계값
    binary = cv2.adaptiveThreshold(
        image,
        255,
        cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv2.THRESH_BINARY,
        11,  # 블록 크기
        2    # C 값
    )
    return binary
```

### 형태학적 연산

노이즈 제거 강화:

```python
# detector.py에 추가

def _apply_morphology(self, binary_image):
    """형태학적 연산으로 노이즈 제거"""
    kernel = np.ones((3, 3), np.uint8)

    # 침식 (작은 점 제거)
    eroded = cv2.erode(binary_image, kernel, iterations=1)

    # 팽창 (객체 복원)
    dilated = cv2.dilate(eroded, kernel, iterations=1)

    return dilated
```

## 환경별 권장 파라미터

### 밝은 환경 (창문 근처)
```python
BINARY_THRESHOLD = 140
MIN_AREA = 600
MAX_AREA = 12000
```

### 어두운 환경 (실내)
```python
BINARY_THRESHOLD = 100
MIN_AREA = 400
MAX_AREA = 8000
```

### 불균등한 조명
```python
# 적응형 이진화 사용 (코드 수정 필요)
```

## 체크리스트

캘리브레이션 전:
- [ ] 실제 작업 환경에서 테스트 이미지 수집
- [ ] 다양한 개수 (0, 1, 5, 10, 최대) 촬영
- [ ] 조명 조건 확인

캘리브레이션 중:
- [ ] 캘리브레이션 도구로 파라미터 조정
- [ ] 모든 테스트 이미지에서 검증
- [ ] 파라미터 저장

캘리브레이션 후:
- [ ] config.py에 파라미터 적용
- [ ] 실제 환경에서 검증
- [ ] 정확도 90% 이상 확인

## 문제 해결

### 캘리브레이션 도구가 실행 안됨

**오류**: `ModuleNotFoundError: No module named 'cv2'`

**해결**:
```bash
pip install opencv-python pillow
```

### 이미지를 불러올 수 없음

**오류**: "이미지 파일을 읽을 수 없습니다"

**해결**:
- 지원 형식 확인: `.jpg`, `.jpeg`, `.png`
- 파일 경로에 한글 없는지 확인

### 감지 결과가 이상함

**증상**: 개수가 비정상적으로 많거나 적음

**해결**:
1. 파라미터 초기화 (기본값으로)
2. 단계별로 다시 조정
3. 테스트 이미지 품질 확인 (흐릿하지 않은지)

## 주기적 재캘리브레이션

다음 경우 재캘리브레이션 권장:
- 누룽지 크기/모양 변경
- 팬 교체
- 조명 환경 변화
- 카메라 위치/각도 변경
- 정확도 저하 (90% 미만)

**권장 주기**: 월 1회 또는 문제 발생 시

---

캘리브레이션 관련 질문은 [GitHub Issues]에 문의하세요.
